import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.preprocessing import LabelEncoder, StandardScaler, RobustScaler
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression, Lasso, Ridge
from statsmodels.stats.outliers_influence import variance_inflation_factor
from statsmodels.tools.tools import add_constant
from sklearn.metrics import r2_score, mean_absolute_error, \
mean_absolute_percentage_error, mean_squared_error


#read dataframe
df=pd.read_csv("../input/california-housing-data/housing.csv")
df.head()

#Check duplicate rows
df.duplicated()

#Check column types
df.dtypes

df.isnull().any()

#the 10 histplots 
fig, ax = plt.subplots(5,2, figsize=(9,9))
sns.histplot(df['longitude'], kde=True, ax=ax[0,0])
sns.histplot(df['latitude'], kde=True, ax=ax[0,1])
sns.histplot(df['housing_median_age'], kde=True, ax=ax[1,0])
sns.histplot(df['total_rooms'], kde=True, ax=ax[1,1])
sns.histplot(df['total_bedrooms'], kde=True, ax=ax[2,0])
sns.histplot(df['population'], kde=True, ax=ax[2,1])
sns.histplot(df['households'], kde=True, ax=ax[3,0])
sns.histplot(df['households'], kde=True, ax=ax[3,1])
sns.histplot(df['median_house_value'], kde=True, ax=ax[4,0])
plt.tight_layout()
plt.show()

#graph for that ocean thing
sns.set(rc={'figure.figsize':[20,20]}, font_scale=1.2)
g = sns.catplot(
x='ocean_proximity',
y='median_house_value',
hue='ocean_proximity',
legend=False,
kind='bar',
data=df,
palette='Set1',
height=8,
aspect=1.5
)
g.set_xticklabels(rotation=45)
plt.tight_layout()
plt.show()

df = df.dropna(how='all')

#do this for all the keys 
sns.boxplot(data=df, x='longitude')

#!pip install -U datasets
#!pip install datasist
import datasist as ds
from datasist.structdata import detect_outliers
outlier = detect_outliers(df, 0, ['total_rooms','total_bedrooms','population','households','median_income','median_house_value'])
df.drop(outlier, inplace=True)
sns.boxplot(data=df, x='median_income')


#heatmap
le = LabelEncoder()
df.ocean_proximity = le.fit_transform(df.ocean_proximity)
plt.figure(figsize=(20,10), dpi=80)
sns.heatmap(df.corr(), cmap='Pastel1', annot=True)

#create train and test 
x = df.drop('median_house_value', axis=1)
y = df['median_house_value']
x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=0.2, random_state=123)

scaler = StandardScaler()
scaler.fit(x_train)
x_train = scaler.fit_transform(x_train)
x_test = scaler.transform(x_test)
LR = LinearRegression()
LR.fit(x_train, y_train)
print(LR.score(x_train, y_train))
print(LR.score(x_test, y_test))

#VIF
XVIF = add_constant(df)
VIF = pd.Series([variance_inflation_factor(XVIF.values, i) for i in range(XVIF.shape[1])], index=XVIF.columns)
VIF

#predicted and actual values graph and analysis
X1 = df.drop(columns=['longitude'])
x_train, x_test, y_train, y_test = train_test_split(X1, y, test_size=0.3, random_state=123)
LR = LinearRegression()
LR.fit(x_train, y_train)
print(LR.score(x_train, y_train))
print(LR.score(x_train, y_train))
lr = LinearRegression()
lr.fit(x_train, y_train)
y_pred = lr.predict(x_test)
evaluate = pd.DataFrame({'Actual': y_test.values.flatten(), 'Predicted': y_pred.flatten()})
evaluate.head(10)
evaluate.head(10).plot(kind='bar')
print(mean_absolute_error(y_test, y_pred))
print(mean_squared_error(y_test, y_pred))




#----Timeseries analysis------graphs only 
mpl.rcParams['lines.linewidth'] = 2
mpl.rcParams['lines.linestyle'] = '--'
mpl.rcParams['axes.prop_cycle'] = cycler(color = ['r' , 'g' , 'b' , 'y'])
data = np.random.randn(50)
plt.plot(data)


#plot for consumption 
import seaborn as sns 
plt.rcParams['figure.figsize'] = (10 , 10)
plt.rcParams['figure.dpi'] = 150 
plt.rcParams['lines.linewidth'] = .4
dfs['Consumption'].plot()

#plot for day wise : 
plt.rcParams['figure.figsize'] = (20 , 10)
dfs['Consumption'].loc['2016-12'].plot(marker = 'o' , linestyle = '--')

# subplots thingie visualiazaiton for each thing 
axes = dfs[cols_to_plot].plot( marker = '.' ,linestyle = 'None' ,  subplots = True )
for ax in axes : 
    ax.set_ylabel("GwH")

#last week of december : 
dfs['Consumption'].loc['2016-12-23' : '2016-12-30'].plot(linestyle = '--' , marker = 'o', figsize = (12 , 10)

#mondays graph  : 
monday = dfs.loc['2017-01' : '2017-02']
monday = monday[monday.index.weekday == 0] 
plt.figure(figsize=(20 , 20))
plt.plot(monday.index , monday['Consumption'] , marker = 'o' , linestyle = '--' , linewidth = 2 )
plt.xlabel('data')
plt.ylabel('power')
plt.title("mondays ka gaph")
plt.show()


#boxplots for solar wind and consump
cols_to_plot = ['Consumption' , 'Solar' , 'Wind'] 
fig , axes = plt.subplots(3 , 1 , figsize = (6 , 7))
for name , ax in zip(cols_to_plot  , axes) :
    sns.boxplot(data = dfs , x ='Month' , y = name , ax=ax) 
    ax.set_ylabel('GwH')
    ax.set_title(name) 

plt.tight_layout()
plt.show()

#boxplot grouped by weekday : 
dfs.boxplot(column = 'Consumption' , by= 'Weekday' , figsize = (20 , 10))

#sampling weekly : 
weekly = dfs['Solar'].resample('W').mean()
plt.rcParams['figure.figsize'] = (20 , 10)
plt.plot(weekly , marker = 'o')

#-- stocks --
import pandas as pd
import matplotlib.pyplot as plt
df = pd.read_csv('
/content/sample_data/sp500_index.csv')


#handle values 
print("\nMissing values before cleaning:")
print(df.isnull().sum())
# Forward fill missing values (optional, depending on your analysis needs)
#df.fillna(method='ffill', inplace=True)
# Drop any rows with remaining NaN values if they exist in critical columns
df.dropna(inplace=True)
#print("\nMissing values after cleaning:")
#print(df.isnull().sum())

#closing prive over time
import matplotlib.pyplot as plt
plt.figure(figsize=(12,6))
plt.plot(df['Close'])
plt.title("Closing Price Over Time")
plt.xlabel("Date")
plt.ylabel("Close Price")
plt.show()

#volume over time
plt.figure(figsize=(12, 4))
plt.plot(df.index, df['Volume'], label='Volume', color='gray')
plt.title('Trading Volume Over Time')#total num of shares traded over time
plt.xlabel('Date')
plt.ylabel('Volume')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()

#stock price trends : 
df[['Open', 'High', 'Low', 'Close']].plot(figsize=(12,6),alpha=0.5)
plt.title("Stock Price Trends")
plt.xlabel("Date")
plt.ylabel("Price")
plt.show()

#rolling mean 30 days 
df['Rolling Mean'] = df['Close'].rolling(window=30).mean()
# Visualize the rolling mean alongside the closing price
plt.figure(figsize=(12, 6))
plt.plot(df.index, df['Close'], label='Closing Price', alpha=0.5)
plt.plot(df.index, df['Rolling Mean'], label='30-Day Rolling Mean', color='red')
plt.title('Closing Price with 30-Day Rolling Mean')
plt.xlabel('Date')
plt.ylabel('Price (USD)')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()


#online retail 
avg_order_value_per_country = df.groupby(['Country', 'InvoiceNo'])['TotalAmount'].sum().groupby('Country').mean().sort_value
print("\nAverage order value per country:")
print(avg_order_value_per_country.head())

#total purchases 
total_purchases_per_country = df.groupby('Country')['InvoiceNo'].nunique().sort_values(ascending=False)
print("\nTotal number of purchases per country:")
print(total_purchases_per_country.head())

#most used 
uk_data = df[df['Country'] == 'United Kingdom']
most_frequent_uk_product = uk_data.groupby('Description')['Quantity'].sum().sort_values(ascending=False).index[0]
print(f"\nMost frequently purchased product in the United Kingdom: {most_frequent_uk_product}")

#avg graph 
top_countries = avg_order_value_per_country.head(10)
plt.figure(figsize=(12, 6))
sns.barplot(x=top_countries.index, y=top_countries.values, palette='viridis')
plt.xticks(rotation=45)
plt.title('Average Order Value per Country (Top 10)')
plt.xlabel('Country')
plt.ylabel('Average Order Value (Â£)')
plt.show()

#total graph 
top_purchase_countries = total_purchases_per_country.head(10)
plt.figure(figsize=(12, 6))
sns.barplot(x=top_purchase_countries.index, y=top_purchase_countries.values, palette='magma')
plt.xticks(rotation=45)
plt.title('Total Number of Purchases per Country (Top 10)')
plt.xlabel('Country')
plt.ylabel('Total Purchases')
plt.show()
